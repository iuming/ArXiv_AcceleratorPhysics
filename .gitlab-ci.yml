# GitLab CI/CDé…ç½®æ–‡ä»¶
# é¡¹ç›®ï¼šArXiv_AcceleratorPhysics
# æ–‡ä»¶ï¼š.gitlab-ci.yml
# ä½œè€…ï¼šMing Liu (ming-1018@foxmail.com)
# æœºæ„ï¼šInstitute of High Energy Physics, Chinese Academy of Sciences
# åˆ›å»ºæ—¥æœŸï¼šJuly 26th, 2025
# æè¿°ï¼šGitLab CI/CDç®¡é“ï¼ŒåŒ…å«ä»£ç è´¨é‡æ£€æŸ¥ã€æµ‹è¯•ã€æ¯æ—¥è®ºæ–‡åˆ†æå’Œéƒ¨ç½²
# 
# é‡è¦è¯´æ˜ï¼š
# 1. GitLab CI/CDçš„å®šæ—¶ä»»åŠ¡åœ¨Project > CI/CD > Schedulesä¸­é…ç½®
# 2. éœ€è¦åœ¨GitLabé¡¹ç›®è®¾ç½®ä¸­é…ç½®ç›¸åº”çš„ç¯å¢ƒå˜é‡
# 3. Runneréœ€è¦æœ‰Pythonç¯å¢ƒæ”¯æŒ
# 
# ä¿®æ”¹è®°å½•ï¼š
# - 2025-07-26: ä»GitHub Actionsè½¬æ¢ä¸ºGitLab CI

# å®šä¹‰é˜¶æ®µ
stages:
  - lint          # ä»£ç è´¨é‡æ£€æŸ¥
  - test          # æµ‹è¯•
  - analyze       # è®ºæ–‡åˆ†æ
  - deploy        # éƒ¨ç½²

# å…¨å±€å˜é‡
variables:
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# ç¼“å­˜é…ç½®
cache:
  paths:
    - .cache/pip
    - .venv/

# ä»£ç è´¨é‡æ£€æŸ¥ä½œä¸š
lint:
  stage: lint
  image: python:${PYTHON_VERSION}
  
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install -r requirements-dev.txt
  
  script:
    - echo "=== ä»£ç è´¨é‡æ£€æŸ¥ ==="
    # ä»£ç æ ¼å¼æ£€æŸ¥
    - black --check --diff src/ || echo "Black formatting issues found"
    # å¯¼å…¥æ’åºæ£€æŸ¥
    - isort --check-only --diff src/ || echo "Import sorting issues found"
    # Flake8æ£€æŸ¥
    - flake8 src/ --max-line-length=88 || echo "Flake8 issues found"
    # Pylintæ£€æŸ¥
    - pylint src/ --output-format=text || echo "Pylint issues found"
    # å®‰å…¨æ£€æŸ¥
    - bandit -r src/ -f txt || echo "Security issues found"
  
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_MERGE_REQUEST_ID
  
  allow_failure: true

# æµ‹è¯•ä½œä¸š
test:
  stage: test
  image: python:${PYTHON_VERSION}
  
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install pytest pytest-cov
  
  script:
    - echo "=== è¿è¡Œæµ‹è¯• ==="
    - pytest --cov=src --cov-report=term --cov-report=xml
  
  coverage: '/TOTAL.*\s+(\d+%)$/'
  
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.xml
    expire_in: 1 week
  
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_MERGE_REQUEST_ID

# æ¯æ—¥ArXivè®ºæ–‡åˆ†æä½œä¸š
daily-arxiv-analysis:
  stage: analyze
  image: python:${PYTHON_VERSION}
  
  before_script:
    - echo "=== æ¯æ—¥ArXivè®ºæ–‡åˆ†æ ==="
    - echo "è§¦å‘æ–¹å¼: $CI_PIPELINE_SOURCE"
    - echo "ä»“åº“: $CI_PROJECT_PATH"
    - echo "åˆ†æ”¯: $CI_COMMIT_REF_NAME"
    - echo "UTCæ—¶é—´: $(date -u)"
    - echo "åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date)"
    - echo "=============================="
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
    # é…ç½®Git
    - git config --global user.email "ci@ihep.ac.cn"
    - git config --global user.name "GitLab CI"
  
  script:
    # è¿è¡Œè®ºæ–‡åˆ†æ
    - cd src
    - python main.py
    - cd ..
    
    # åˆ›å»ºdataç›®å½•
    - mkdir -p data/papers data/analysis data/statistics
    
    # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
    - git add -f data/ || echo "No data directory to add"
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
    - |
      if git diff --staged --quiet; then
        echo "No changes to commit"
        exit 0
      fi
    
    # æäº¤æ›´æ”¹
    - DATE=$(date +%Y-%m-%d)
    - git commit -m "ğŸ¤– Daily ArXiv analysis for $DATE"
    - git push origin HEAD:$CI_COMMIT_REF_NAME
  
  rules:
    # å®šæ—¶ä»»åŠ¡è§¦å‘
    - if: $CI_PIPELINE_SOURCE == "schedule"
    # æ‰‹åŠ¨è§¦å‘
    - if: $CI_PIPELINE_SOURCE == "web"
    # æ¨é€åˆ°mainåˆ†æ”¯ä¸”ä¿®æ”¹äº†å·¥ä½œæµæ–‡ä»¶æ—¶è§¦å‘ï¼ˆæµ‹è¯•ç”¨ï¼‰
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - .gitlab-ci.yml
  
  # åªåœ¨æœ‰APIå¯†é’¥æ—¶è¿è¡Œ
  rules:
    - if: $OPENAI_API_KEY || $DEEPSEEK_API_KEY || $HAI_API_KEY || $ANTHROPIC_API_KEY
  
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: "0"

# Webæ¼”ç¤ºéƒ¨ç½²ä½œä¸š
deploy-web-demo:
  stage: deploy
  image: python:${PYTHON_VERSION}
  
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
  
  script:
    - echo "=== æ„å»ºWebæ¼”ç¤º ==="
    # åˆ›å»ºæ¼”ç¤ºé¡µé¢ç›®å½•
    - mkdir -p public/static public/assets
    
    # å¤åˆ¶é™æ€èµ„æº
    - cp -r static/* public/static/
    - cp -r templates/web/* public/
    
    # ç”Ÿæˆæ¼”ç¤ºæ•°æ®
    - python -c "
import json
import os
from datetime import datetime, timedelta

# åˆ›å»ºæ¼”ç¤ºæ•°æ®
demo_data = {
    'stats': {
        'total_papers': 443,
        'analyzed_papers': 365,
        'today_papers': 12,
        'categories_count': 5,
        'last_update': '$(date +%Y-%m-%d\ %H:%M:%S)'
    },
    'recent_papers': [
        {
            'id': '2507.18310v1',
            'title': 'Advanced Beam Dynamics Simulation for High-Energy Accelerators',
            'authors': ['Dr. Smith', 'Prof. Johnson'],
            'published': '2025-07-25',
            'categories': ['physics.acc-ph'],
            'summary': 'This paper presents a comprehensive study of beam dynamics...'
        },
        {
            'id': '2507.18226v1',
            'title': 'Novel Superconducting Cavity Design for Linear Accelerators',
            'authors': ['Dr. Chen', 'Dr. Wang'],
            'published': '2025-07-24',
            'categories': ['physics.acc-ph'],
            'summary': 'We propose an innovative superconducting cavity design...'
        }
    ]
}

# ä¿å­˜æ¼”ç¤ºæ•°æ®
with open('public/assets/demo-data.json', 'w') as f:
    json.dump(demo_data, f, indent=2)
"
    
    # åˆ›å»ºç´¢å¼•é¡µé¢
    - echo '<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArXiv åŠ é€Ÿå™¨ç‰©ç†è®ºæ–‡åˆ†æç³»ç»Ÿ</title>
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
    <div class="container">
        <h1>ğŸš€ ArXiv åŠ é€Ÿå™¨ç‰©ç†è®ºæ–‡åˆ†æç³»ç»Ÿ</h1>
        <p>æ¬¢è¿ä½¿ç”¨ArXivåŠ é€Ÿå™¨ç‰©ç†è®ºæ–‡è‡ªåŠ¨åˆ†æç³»ç»Ÿæ¼”ç¤º</p>
        <div class="demo-links">
            <a href="index.html" class="btn btn-primary">ä¸»é¡µ</a>
            <a href="papers.html" class="btn btn-secondary">è®ºæ–‡åˆ—è¡¨</a>
            <a href="statistics.html" class="btn btn-info">ç»Ÿè®¡åˆ†æ</a>
        </div>
        <div class="stats">
            <h2>ğŸ“Š ç³»ç»Ÿç»Ÿè®¡</h2>
            <p>æ€»è®ºæ–‡æ•°: 443</p>
            <p>å·²åˆ†æ: 365</p>
            <p>ä»Šæ—¥æ–°å¢: 12</p>
            <p>æœ€åæ›´æ–°: $(date +%Y-%m-%d\ %H:%M:%S)</p>
        </div>
    </div>
</body>
</html>' > public/index.html
  
  artifacts:
    paths:
      - public
    expire_in: 1 week
  
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  
  # GitLab Pageséƒ¨ç½²
  pages:
    stage: deploy
    dependencies:
      - deploy-web-demo
    script:
      - echo "Deploying to GitLab Pages"
    artifacts:
      paths:
        - public
    rules:
      - if: $CI_COMMIT_BRANCH == "main"

# å¥åº·æ£€æŸ¥ä½œä¸š
health-check:
  stage: test
  image: python:${PYTHON_VERSION}
  
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
  
  script:
    - echo "=== ç³»ç»Ÿå¥åº·æ£€æŸ¥ ==="
    - python health_check.py
  
  artifacts:
    paths:
      - logs/health_reports/
    expire_in: 1 week
  
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
  
  allow_failure: true
