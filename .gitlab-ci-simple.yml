# GitLab CI - æ¯æ—¥è®ºæ–‡åˆ†æä¸“ç”¨é…ç½®
# å¦‚æœä½ åªéœ€è¦æ¯æ—¥è®ºæ–‡åˆ†æåŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªç®€åŒ–ç‰ˆæœ¬

stages:
  - analyze

variables:
  PYTHON_VERSION: "3.11"

daily-arxiv-analysis:
  stage: analyze
  image: python:${PYTHON_VERSION}
  
  before_script:
    - echo "=== æ¯æ—¥ArXivè®ºæ–‡åˆ†æ ==="
    - echo "è§¦å‘æ–¹å¼: $CI_PIPELINE_SOURCE"
    - echo "ä»“åº“: $CI_PROJECT_PATH"
    - echo "åˆ†æ”¯: $CI_COMMIT_REF_NAME"
    - echo "UTCæ—¶é—´: $(date -u)"
    - echo "åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date)"
    - echo "=============================="
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
    - git config --global user.email "ci@ihep.ac.cn"
    - git config --global user.name "GitLab CI"
  
  script:
    # è¿è¡Œè®ºæ–‡åˆ†æ
    - cd src && python main.py && cd ..
    
    # æäº¤ç»“æœ
    - mkdir -p data/papers data/analysis data/statistics
    - git add -f data/ || echo "No data to add"
    - |
      if ! git diff --staged --quiet; then
        DATE=$(date +%Y-%m-%d)
        git commit -m "ğŸ¤– Daily ArXiv analysis for $DATE"
        git push origin HEAD:$CI_COMMIT_REF_NAME
      else
        echo "No changes to commit"
      fi
  
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - .gitlab-ci.yml
  
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: "0"
