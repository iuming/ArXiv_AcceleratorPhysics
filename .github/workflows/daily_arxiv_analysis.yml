# GitHub Actionså·¥ä½œæµé…ç½®æ–‡ä»¶
# é¡¹ç›®ï¼šArXiv_AcceleratorPhysics
# æ–‡ä»¶ï¼šdaily_arxiv_analysis.yml
# ä½œè€…ï¼šMing Liu (ming-1018@foxmail.com)
# æœºæ„ï¼šInstitute of High Energy Physics, Chinese Academy of Sciences
# åˆ›å»ºæ—¥æœŸï¼šJuly 25th, 2025
# æè¿°ï¼šæ¯æ—¥è‡ªåŠ¨æŠ“å–å’Œåˆ†æArXivåŠ é€Ÿå™¨ç‰©ç†è®ºæ–‡çš„GitHub Actionså·¥ä½œæµ
#       è‡ªåŠ¨è¿è¡Œè®ºæ–‡æŠ“å–ã€LLMåˆ†æã€æ•°æ®å¤„ç†å’Œç»“æœæäº¤
# 
# é‡è¦è¯´æ˜ï¼š
# 1. GitHub Actionsçš„cronä½œä¸šåªåœ¨é»˜è®¤åˆ†æ”¯ä¸Šè¿è¡Œ
# 2. å®šæ—¶ä»»åŠ¡å¯èƒ½æœ‰5-10åˆ†é’Ÿçš„å»¶è¿Ÿ
# 3. å¦‚æœä»“åº“60å¤©æ²¡æœ‰æ´»åŠ¨ï¼Œå®šæ—¶ä»»åŠ¡ä¼šè¢«è‡ªåŠ¨ç¦ç”¨
# 4. å»ºè®®å®šæœŸæ‰‹åŠ¨è§¦å‘ä»¥ä¿æŒæ´»è·ƒæ€§
# 
# ä¿®æ”¹è®°å½•ï¼š
# - 2025-07-25: åˆå§‹åˆ›å»º
# - 2025-07-25: æ·»åŠ å¤šLLMæ”¯æŒå’Œé”™è¯¯å¤„ç†
# - 2025-07-26: æ·»åŠ è°ƒè¯•ä¿¡æ¯å’Œè§¦å‘æ¡ä»¶ä¼˜åŒ–

name: Daily ArXiv Accelerator Physics Analysis

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´00:00è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´08:00ï¼‰
    # æ³¨æ„ï¼šGitHub Actionsçš„cronå¯èƒ½æœ‰5-10åˆ†é’Ÿçš„å»¶è¿Ÿ
    - cron: '0 0 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]  # åœ¨mainåˆ†æ”¯æ¨é€æ—¶ä¹Ÿè§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
    paths:
      - '.github/workflows/daily_arxiv_analysis.yml'  # åªåœ¨å·¥ä½œæµæ–‡ä»¶å˜æ›´æ—¶è§¦å‘

# è®¾ç½®æƒé™
permissions:
  contents: write  # å…è®¸æ¨é€ä»£ç 
  issues: write    # å…è®¸åˆ›å»ºissue

jobs:
  analyze-papers:
    runs-on: ubuntu-latest
    
    steps:
    - name: Display workflow info
      run: |
        echo "=== Workflow Execution Info ==="
        echo "Trigger event: ${{ github.event_name }}"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref }}"
        echo "UTC Time: $(date -u)"
        echo "Beijing Time: $(TZ='Asia/Shanghai' date)"
        echo "=============================="
        
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # è·å–å®Œæ•´å†å²
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        
    - name: Run ArXiv analysis
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        HAI_API_KEY: ${{ secrets.HAI_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd src
        python main.py
        
    - name: Commit and push results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # åˆ›å»ºdataç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        mkdir -p data/papers data/analysis data/statistics
        
        # æ·»åŠ æ–°ç”Ÿæˆçš„æ–‡ä»¶ï¼Œå¼ºåˆ¶æ·»åŠ å³ä½¿è¢«.gitignoreå¿½ç•¥
        git add -f data/ || echo "No data directory to add"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        # è·å–å½“å‰æ—¥æœŸ
        DATE=$(date +%Y-%m-%d)
        
        # æäº¤æ›´æ”¹
        git commit -m "ğŸ¤– Daily ArXiv analysis for $DATE"
        git push
        
    - name: Create summary issue
      if: success()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          const date = new Date().toISOString().split('T')[0];
          const summaryPath = `data/analysis/${date}/daily_summary.md`;
          
          if (fs.existsSync(summaryPath)) {
            const summary = fs.readFileSync(summaryPath, 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š Daily ArXiv Analysis Summary - ${date}`,
              body: summary,
              labels: ['daily-summary', 'arxiv-analysis']
            });
          }
